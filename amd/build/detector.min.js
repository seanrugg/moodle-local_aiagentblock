/**
 * AI Agent Detection JavaScript Module (AMD format for Moodle)
 *
 * @module     local_aiagentblock/detector
 * @copyright  2025
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */ define(["jquery","core/ajax"],function(e,t){"use strict";let n=0,i=[];function r(){n>=60&&a()}function a(){e.ajax({url:M.cfg.wwwroot+"/local/aiagentblock/detect.php",method:"POST",data:{detection:1,score:n,reasons:i.join(",")}})}return{init:function e(){!function e(){let t=[{name:"webdriver",check:function(){return!0===navigator.webdriver},weight:50},{name:"automation_property",check:function(){let e=["webdriver","__webdriver_evaluate","__selenium_evaluate","__webdriver_script_function","__driver_evaluate","__webdriver_unwrapped","__driver_unwrapped","_Selenium_IDE_Recorder","_selenium","callSelenium","$cdc_","$chrome_asyncScriptInfo","__$webdriverAsyncExecutor","__perplexity__","__comet__","perplexityAgent","cometAgent"];for(let t=0;t<e.length;t++)if(window[e[t]]||document[e[t]])return!0;return!1},weight:50},{name:"perplexity_elements",check:function(){let e=document.querySelectorAll('[class*="perplexity"], [class*="comet"], [data-perplexity], [data-comet], [id*="perplexity"], [id*="comet"]');return e.length>0},weight:45},{name:"agent_overlay",check:function(){let e=document.querySelectorAll('[class*="agent"], [class*="assistant"], [id*="agent"], [id*="assistant"]');return Array.from(e).some(function(e){let t=window.getComputedStyle(e);return"fixed"===t.position||"absolute"===t.position})},weight:35},{name:"no_plugins",check:function(){return navigator.plugins&&0===navigator.plugins.length},weight:25},{name:"headless_ua",check:function(){return/HeadlessChrome|PhantomJS|Selenium|Puppeteer/i.test(navigator.userAgent)},weight:30},{name:"no_languages",check:function(){return!navigator.languages||0===navigator.languages.length},weight:15},{name:"chrome_without_chrome",check:function(){return!window.chrome&&navigator.userAgent.includes("Chrome")},weight:15},{name:"no_permissions",check:function(){return void 0===navigator.permissions},weight:15}];t.forEach(function(e){try{e.check()&&(n+=e.weight,i.push(e.name+"_"+e.weight))}catch(t){}})}();let t=function e(){try{let t=document.createElement("canvas"),n=t.getContext("2d");if(!n)return{detected:!0,score:40,reason:"no_canvas_context"};n.textBaseline="top",n.font="14px Arial",n.textBaseline="alphabetic",n.fillStyle="#f60",n.fillRect(125,1,62,20),n.fillStyle="#069",n.fillText("Moodle Test",2,15),n.fillStyle="rgba(102, 204, 0, 0.7)",n.fillText("Moodle Test",4,17);let i=t.toDataURL();if("data:,"===i||i.length<100)return{detected:!0,score:40,reason:"canvas_empty"};return{detected:!1,score:0}}catch(r){return{detected:!0,score:40,reason:"canvas_error"}}}();t.detected&&(n+=t.score,i.push("canvas_"+t.reason)),["html2canvas","dom-to-image","domtoimage","rasterizeHTML","html2image"].forEach(function(e){window[e]&&(n+=35,i.push("screenshot_library_"+e))}),function e(){if(!navigator.mediaDevices||!navigator.mediaDevices.getDisplayMedia)return;let t=navigator.mediaDevices.getDisplayMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getDisplayMedia=function(){return n+=50,i.push("screen_capture_api_called"),r(),t.apply(this,arguments)}}(),function e(){if(!window.MediaRecorder)return;let t=window.MediaRecorder;window.MediaRecorder=function(){return n+=40,i.push("media_recorder_instantiated"),r(),new t(...arguments)},window.MediaRecorder.prototype=t.prototype}(),navigator.permissions&&navigator.permissions.query&&navigator.permissions.query({name:"display-capture"}).then(function(e){"granted"===e.state&&(n+=45,i.push("display_capture_permission_granted"),r()),e.addEventListener("change",function(){"granted"===e.state&&(n+=45,i.push("display_capture_permission_changed"),r())})}).catch(function(){});let c;c=[],document.addEventListener("input",function(){if(c.push(Date.now()),c.length>=3){let e=c[c.length-1]-c[0];e<500&&(n+=30,i.push("rapid_form_filling_30"),c=[],r())}},!0),function e(){let t=0,a=0,c=document.createElement.bind(document);document.createElement=function(e){let o=c(e);return e&&"canvas"===e.toLowerCase()&&(t++,setTimeout(function(){let e=window.getComputedStyle(o);("none"===e.display||"hidden"===e.visibility)&&++a>=2&&(n+=25,i.push("multiple_hidden_canvases_25"),r())},100),t>5&&(n+=20,i.push("excessive_canvas_count_20"),r())),o}}(),function e(){let t=0,a=Date.now();document.addEventListener("mousemove",function(){t++}),setTimeout(function(){0===t&&Date.now()-a>5e3&&(n+=35,i.push("no_mouse_movement_35"),r())},5e3)}(),n>=60&&a(),setTimeout(function(){n>=60&&a()},1e3)}}});
